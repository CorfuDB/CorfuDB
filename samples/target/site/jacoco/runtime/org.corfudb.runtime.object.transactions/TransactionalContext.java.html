<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>TransactionalContext.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">samples</a> &gt; <a href="../index.html" class="el_bundle">runtime</a> &gt; <a href="index.source.html" class="el_package">org.corfudb.runtime.object.transactions</a> &gt; <span class="el_source">TransactionalContext.java</span></div><h1>TransactionalContext.java</h1><pre class="source lang-java linenums">package org.corfudb.runtime.object.transactions;

import java.util.Collections;
import java.util.Deque;
import java.util.LinkedList;
import java.util.List;
import java.util.stream.Collectors;

import lombok.extern.slf4j.Slf4j;
import org.corfudb.runtime.exceptions.unrecoverable.UnrecoverableCorfuError;

/** A class which allows access to transactional contexts, which manage
 * transactions. The static methods of this class provide access to the
 * thread's transaction stack, which is a stack of transaction contexts
 * active for a particular thread.
 *
 * &lt;p&gt;Created by mwei on 1/11/16.
 */
<span class="nc" id="L19">@Slf4j</span>
<span class="nc" id="L20">public class TransactionalContext {</span>

    /** A thread local stack containing all transaction contexts
     * for a given thread.
     */
    private static final ThreadLocal&lt;Deque&lt;AbstractTransactionalContext&gt;&gt;
<span class="nc" id="L26">            threadTransactionStack = ThreadLocal.withInitial(</span>
            LinkedList&lt;AbstractTransactionalContext&gt;::new);

    /** Whether or not the current thread is in a nested transaction.
     *
     * @return  True, if the current thread is in a nested transaction.
     */
    public static boolean isInNestedTransaction() {
<span class="nc bnc" id="L34" title="All 2 branches missed.">        return threadTransactionStack.get().size() &gt; 1;</span>
    }

    /**
     * Returns the transaction stack for the calling thread.
     *
     * @return The transaction stack for the calling thread.
     */
    public static Deque&lt;AbstractTransactionalContext&gt; getTransactionStack() {
<span class="nc" id="L43">        return threadTransactionStack.get();</span>
    }

    /**
     * Returns the current transactional context for the calling thread.
     *
     * @return The current transactional context for the calling thread.
     */
    public static AbstractTransactionalContext getCurrentContext() {
<span class="nc" id="L52">        return getTransactionStack().peekFirst();</span>
    }

    /**
     * Returns the last transactional context (parent/root) for the calling thread.
     *
     * @return The last transactional context for the calling thread.
     */
    public static AbstractTransactionalContext getRootContext() {
<span class="nc" id="L61">        return getTransactionStack().peekLast();</span>
    }

    /**
     * Returns whether or not the calling thread is in a transaction.
     *
     * @return True, if the calling thread is in a transaction.  False otherwise.
     */
    public static boolean isInTransaction() {
<span class="nc bnc" id="L70" title="All 2 branches missed.">        return getTransactionStack().peekFirst() != null;</span>
    }

    /** Add a new transactional context to the thread's transaction stack.
     *
     * @param context   The context to add to the transaction stack.
     * @return          The context which was added to the transaction stack.
     */
    public static AbstractTransactionalContext newContext(AbstractTransactionalContext context) {
<span class="nc" id="L79">        log.debug(&quot;TX begin[{}]&quot;, context);</span>
<span class="nc" id="L80">        getTransactionStack().addFirst(context);</span>
<span class="nc" id="L81">        return context;</span>
    }

    /** Remove the most recent transaction context from the transaction stack.
     *
     * @return          The context which was removed from the transaction stack.
     */
    public static AbstractTransactionalContext removeContext() {
<span class="nc" id="L89">        AbstractTransactionalContext r = getTransactionStack().pollFirst();</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">        if (getTransactionStack().isEmpty()) {</span>
<span class="nc" id="L91">            synchronized (getTransactionStack()) {</span>
<span class="nc" id="L92">                getTransactionStack().notifyAll();</span>
<span class="nc" id="L93">            }</span>
        }
<span class="nc" id="L95">        return r;</span>
    }

    /**
     * Get the transaction stack as a list.
     * @return  The transaction stack as a list.
     */
    public static List&lt;AbstractTransactionalContext&gt; getTransactionStackAsList() {
        List&lt;AbstractTransactionalContext&gt; listReverse =
<span class="nc" id="L104">                getTransactionStack().stream().collect(Collectors.toList());</span>
<span class="nc" id="L105">        Collections.reverse(listReverse);</span>
<span class="nc" id="L106">        return listReverse;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>